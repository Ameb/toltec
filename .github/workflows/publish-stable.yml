name: stable
on:
    push:
        branches:
            - stable
jobs:
    images:
        name: Build and publish images
        runs-on: ubuntu-latest
        steps:
            - name: Checkout the Git repository
              uses: actions/checkout@v2
            - name: Build and publish images
              run: |
                echo "${{ secrets.CR_PAT }}" | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin
                ./scripts/build-images -p image
    packages:
        needs: images
        name: Build and publish packages
        runs-on: ubuntu-latest
        steps:
            - name: Checkout the Git repository
              uses: actions/checkout@v2
            - name: Build packages
              run: ./scripts/build-repo package build
            - name: Fetch current channel and source date epoch
              run: |
                echo "::set-env name=CHANNEL::$(git rev-parse --abbrev-ref HEAD)"
                echo "::set-env name=SOURCE_DATE_EPOCH::$(git log -1 --pretty=%ct)"
            - name: Transfer packages and index
              run: |
                mkdir -p private
                chmod 700 private
                echo "${{ secrets.SSH_PRIVATE_KEY }}" > private/id_rsa
                echo "${{ secrets.SSH_KNOWN_HOSTS }}" > private/known_hosts
                chmod 600 private/*
                rsync -avz \
                    -e "ssh -i private/id_rsa -o UserKnownHostsFile=private/known_hosts" \
                    build/repo/ "${{ secrets.REMOTE }}":/srv/toltec/"$CHANNEL"
            - name: Set atime and mtime of published files
              run: |
                ssh -i private/id_rsa -o UserKnownHostsFile=private/known_hosts \
                    "${{ secrets.REMOTE }}" -- \
                    find "/srv/toltec/$CHANNEL" -exec touch --no-dereference --date="@${SOURCE_DATE_EPOCH}" {} +
